<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>Baby Language Lab Scripts: C:/Users/Wayne/Documents/baby-lab/bll_app/parsers/trs_parser.py Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="bll_icon.jpg"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Baby Language Lab Scripts
   </div>
   <div id="projectbrief">A collection of data processing tools.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Packages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('trs__parser_8py_source.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">trs_parser.py</div>  </div>
</div><!--header-->
<div class="contents">
<a href="trs__parser_8py.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno"><a class="code" href="namespaceparsers_1_1trs__parser.html">    1</a></span>&#160;<span class="comment">## @package parsers.trs_parser</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="keyword">import</span> xml.etree.ElementTree</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="keyword">import</span> logging</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="keyword">import</span> re</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="keyword">import</span> traceback</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="keyword">import</span> random</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="keyword">from</span> <a class="code" href="namespacedata__structs_1_1segment.html">data_structs.segment</a> <span class="keyword">import</span> Segment</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="keyword">from</span> <a class="code" href="namespacedata__structs_1_1utterance.html">data_structs.utterance</a> <span class="keyword">import</span> Utterance</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="keyword">from</span> <a class="code" href="namespacedata__structs_1_1speaker.html">data_structs.speaker</a> <span class="keyword">import</span> Speaker</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="keyword">from</span> <a class="code" href="namespacedb_1_1bll__database.html">db.bll_database</a> <span class="keyword">import</span> DBConstants</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="keyword">from</span> <a class="code" href="namespaceparsers_1_1state__machines.html">parsers.state_machines</a> <span class="keyword">import</span> *</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="keyword">from</span> <a class="code" href="namespaceparsers_1_1errors.html">parsers.errors</a> <span class="keyword">import</span> *</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="keyword">from</span> <a class="code" href="namespacedata__structs_1_1error__collector.html">data_structs.error_collector</a> <span class="keyword">import</span> ErrorCollector</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="keyword">from</span> <a class="code" href="namespaceparsers_1_1parser__tools.html">parsers.parser_tools</a> <span class="keyword">import</span> *</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment">## This class parses transcribed (or untranscribed) TRS files, producing output in the form of Segment objects (which contain Utterance objects).</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment">#  The tasks of assigning Utterance start/end times and linking segments into chains are passed off to the parsers.state_machines.StateMachines class.</span></div>
<div class="line"><a name="l00020"></a><span class="lineno"><a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html">   20</a></span>&#160;<span class="keyword">class </span><a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html" title="This class parses transcribed (or untranscribed) TRS files, producing output in the form of Segment o...">TRSParser</a>(object):</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;    <span class="comment">#every correctly transcribed line should match this regex</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;    <span class="comment">#General format: &quot;&lt;transcription phrase&gt; &lt;lena notes&gt; &lt;pipe-delimited LENA codes&gt;&lt;pipe-delimited transcriber codes&gt;&quot;</span></div>
<div class="line"><a name="l00023"></a><span class="lineno"><a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a3943c5ba1314c4428272880a1003f1cd">   23</a></span>&#160;    TRANS_LINE_REGEX = <span class="stringliteral">&#39;^\s*([^\|]*?)\s*(&#39;</span> + <span class="stringliteral">&#39;|&#39;</span>.join(DBConstants.LENA_NOTES_CODES.get_all_options_codes()) + <span class="stringliteral">&#39;)?\s*(?:\|(.*)\|)?\s*(?:`)*$&#39;</span> <span class="comment">#note: allow for backticks at the end of line (occurs in some TRS files for some unknown reason...)</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;    <span class="comment">#TRANS_LINE_REGEX = &#39;^\s*([^\|]*?)\s*((?:(?:&#39; + &#39;|&#39;.join(DBConstants.LENA_NOTES_CODES.get_all_options_codes()) + &#39;)\s*)*)(?:\|(.*)\|)?\s*(?:`)*$&#39; #note: allow for backticks at the end of line (occurs in some TRS files for some unknown reason...)</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;    </div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;    <span class="comment">#this regex is used to check for angle brackets to see if a particular transcription should be marked as &#39;overlapping&#39;</span></div>
<div class="line"><a name="l00027"></a><span class="lineno"><a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#adbc8ccdb684b9280fd3d7d394cb2d0e9">   27</a></span>&#160;    TRANS_OVERLAP_REGEX = <span class="stringliteral">&#39;\s*&lt;.*&gt;\s*&#39;</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;    <span class="comment"># TRANS_CODE_REGEX = &#39;^\s*\|\s*[%s]\s*\|\s*[%s]\s*\|\s*[%s]+\s*\|\s*[%s]\s*\|\s*$&#39; % (</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;    <span class="comment">#     &#39;&#39;.join(DBConstants.TRANS_CODES[0].get_all_options_codes()),</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;    <span class="comment">#     &#39;&#39;.join(DBConstants.TRANS_CODES[1].get_all_options_codes()),</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;    <span class="comment">#     &#39;&#39;.join(DBConstants.TRANS_CODES[2].get_all_options_codes()) + &#39;\s&#39;,</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;    <span class="comment">#     &#39;&#39;.join(DBConstants.TRANS_CODES[3].get_all_options_codes())</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;    <span class="comment">#     )</span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;    <span class="comment">## Constructor</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;    <span class="comment">#  @param self</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;    <span class="comment">#  @param filename (string) full path to TRS file to parse</span></div>
<div class="line"><a name="l00039"></a><span class="lineno"><a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a76b30b9f39c0e894812890017145ab6d">   39</a></span>&#160;    <span class="keyword">def </span><a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a76b30b9f39c0e894812890017145ab6d" title="Constructor.">__init__</a>(self, filename):</div>
<div class="line"><a name="l00040"></a><span class="lineno"><a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#ab5693185eb080b6dafb64c2603300852">   40</a></span>&#160;        self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#ab5693185eb080b6dafb64c2603300852">logger</a> = logging.getLogger(__name__)</div>
<div class="line"><a name="l00041"></a><span class="lineno"><a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a6cfdc1be076c60c64a5b5ea2da90d81b">   41</a></span>&#160;        self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a6cfdc1be076c60c64a5b5ea2da90d81b">filename</a> = filename</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;        <span class="comment">#perform setup of data structures used in the parsing process</span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;        self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#abc3f53781afaa1315e0ed0538fcc38ba" title="Sets up data structures used to iterate through the XML and track segments, utterances, errors, etc.">_init_data_structures</a>()</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;    <span class="comment">## Sets up data structures used to iterate through the XML and track segments, utterances, errors, etc.</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;    <span class="comment">#  @param self</span></div>
<div class="line"><a name="l00048"></a><span class="lineno"><a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#abc3f53781afaa1315e0ed0538fcc38ba">   48</a></span>&#160;    <span class="keyword">def </span><a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#abc3f53781afaa1315e0ed0538fcc38ba" title="Sets up data structures used to iterate through the XML and track segments, utterances, errors, etc.">_init_data_structures</a>(self):</div>
<div class="line"><a name="l00049"></a><span class="lineno"><a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a2ac08990a7782ce750a185a004a3f45d">   49</a></span>&#160;        self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a2ac08990a7782ce750a185a004a3f45d">error_collector</a> = <a class="code" href="classdata__structs_1_1error__collector_1_1_error_collector.html" title="This class maintains a collection of errors and warnings, providing various lookup methods to retreiv...">ErrorCollector</a>()</div>
<div class="line"><a name="l00050"></a><span class="lineno"><a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a9a7a1591931fbb8f57d958c9cc0f10b9">   50</a></span>&#160;        self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a9a7a1591931fbb8f57d958c9cc0f10b9">segments</a> = []</div>
<div class="line"><a name="l00051"></a><span class="lineno"><a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a99ae17223c6ab8029b9b307d151984da">   51</a></span>&#160;        self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a99ae17223c6ab8029b9b307d151984da">speakers</a> = {}</div>
<div class="line"><a name="l00052"></a><span class="lineno"><a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a98e49ff8cc4d465a391072925eb0d181">   52</a></span>&#160;        self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a98e49ff8cc4d465a391072925eb0d181">utter_index</a> = {} <span class="comment">#for lookup by utter_id, only build on demand</span></div>
<div class="line"><a name="l00053"></a><span class="lineno"><a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a93736f8c4f06e5bae05b1a4433a2743d">   53</a></span>&#160;        self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a93736f8c4f06e5bae05b1a4433a2743d">parsed</a> = <span class="keyword">False</span></div>
<div class="line"><a name="l00054"></a><span class="lineno"><a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#aa2e756eb35e9805d84ce3de0ce9a015a">   54</a></span>&#160;        self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#aa2e756eb35e9805d84ce3de0ce9a015a">link_sm</a> = <a class="code" href="classparsers_1_1state__machines_1_1_link_utters_state_machine.html" title="This class handles the job of linking together Utterances (via their next/prev pointers) that are mar...">LinkUttersStateMachine</a>(self)</div>
<div class="line"><a name="l00055"></a><span class="lineno"><a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a1b123c13ba97fd29d0c5ebca469926e7">   55</a></span>&#160;        self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a1b123c13ba97fd29d0c5ebca469926e7">total_utters</a> = 0</div>
<div class="line"><a name="l00056"></a><span class="lineno"><a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a2e31c227510ed8290d0ad971aa3107c9">   56</a></span>&#160;        self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a2e31c227510ed8290d0ad971aa3107c9">tree</a> = <span class="keywordtype">None</span></div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;        <span class="comment">#Use Python ElementTree library to parse the XML in the TRS file.</span></div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;        <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;            self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a2e31c227510ed8290d0ad971aa3107c9">tree</a> = xml.etree.ElementTree.parse(self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a6cfdc1be076c60c64a5b5ea2da90d81b">filename</a>)</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;            </div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;        <span class="keywordflow">except</span> Exception <span class="keyword">as</span> e:</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;            self.logger.error(<span class="stringliteral">&quot;Unable to open TRS file. Exception: %s&quot;</span> % e)</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;            self.logger.error(<span class="stringliteral">&quot;Stack trace: %s&quot;</span> % (traceback.format_exc()))</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;    <span class="comment">## Retreives the errors and warnings found by this parser in the form of an ErrorCollector object</span></div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;    <span class="comment">#  It provides methods to look up various errors/warnings by type.</span></div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    <span class="comment">#  @param self</span></div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;    <span class="comment">#  @returns (ErrorCollector) - this object can be used to lookup errors/warnings by type (see errors.ErrorCollector class)</span></div>
<div class="line"><a name="l00070"></a><span class="lineno"><a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#ab92ae64a35609d7b50e5aafadbd85275">   70</a></span>&#160;    <span class="keyword">def </span><a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#ab92ae64a35609d7b50e5aafadbd85275" title="Retreives the errors and warnings found by this parser in the form of an ErrorCollector object It pro...">get_errors</a>(self):</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;        <span class="keywordflow">return</span> self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a2ac08990a7782ce750a185a004a3f45d">error_collector</a></div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    <span class="comment">## Resets internal data structures and parses the TRS file a second time. Useful if the file has changed since the last parse.</span></div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;    <span class="comment">#  All cached segments/utterances from the last parse are cleared.</span></div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;    <span class="comment">#  @param self</span></div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;    <span class="comment">#  @param progress_update_fcn (function=None) function accepting a value in [0,1] to display as a progress bar - see utils.ProgressDialog. This value is used to indicate the level of completeness &lt;em&gt;of the current phase&lt;/em&gt;</span></div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;    <span class="comment">#  @param progress_next_phase_fcn(function=None) - moves the progress bar to the next phase, which causes new text to be displayed in the bar - see utils.ProgressDialog</span></div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;    <span class="comment">#  @param validate (boolean=True) set to True if you want the parser to check for errors (can be retreived with get_errors()), False otherwise</span></div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    <span class="comment">#  @param seg_filters (list=[]) list of SegFilter objects. These filters are applied to the segments list in a permanent manner (i.e. anything they filter out will not be returned by this parser)</span></div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;    <span class="comment">#  @returns (list) list of Segment objects</span></div>
<div class="line"><a name="l00081"></a><span class="lineno"><a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a4b73a4220c2778f057f947870e9da3ac">   81</a></span>&#160;    <span class="keyword">def </span><a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a4b73a4220c2778f057f947870e9da3ac" title="Resets internal data structures and parses the TRS file a second time.">re_parse</a>(self, progress_update_fcn=None, progress_next_phase_fcn=None, validate=True, seg_filters=[], remove_bad_trans_codes=True):</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;        self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#abc3f53781afaa1315e0ed0538fcc38ba" title="Sets up data structures used to iterate through the XML and track segments, utterances, errors, etc.">_init_data_structures</a>()</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;        </div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;        <span class="keywordflow">return</span> self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a89272bfa78d844871930a7a09652c7e6" title="Parses the TRS file, returning a list of Segments.">parse</a>(progress_update_fcn=progress_update_fcn,</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;                          progress_next_phase_fcn=progress_next_phase_fcn,</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;                          validate=validate,</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;                          seg_filters=seg_filters,</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;                          remove_bad_trans_codes=remove_bad_trans_codes)</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;    <span class="comment">## Parses the TRS file, returning a list of Segments.</span></div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;    <span class="comment">#  @param self</span></div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;    <span class="comment">#  @param progress_update_fcn (function=None) function accepting a value in [0,1] to display as a progress bar - see utils.ProgressDialog. This value is used to indicate the level of completeness &lt;em&gt;of the current phase&lt;/em&gt;</span></div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    <span class="comment">#  @param progress_next_phase_fcn(function=None) - moves the progress bar to the next phase, which causes new text to be displayed in the bar - see utils.ProgressDialog</span></div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;    <span class="comment">#  @param validate (boolean=True) set to True if you want the parser to check for errors (can be retreived with get_errors()), False otherwise</span></div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;    <span class="comment">#  @param seg_filters (list=[]) list of SegFilter objects. These filters are applied to the internal segments list in a permanent manner (i.e. anything they filter out will not be returned by this parser)</span></div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;    <span class="comment">#  @returns (list) list of Segment objects</span></div>
<div class="line"><a name="l00097"></a><span class="lineno"><a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a89272bfa78d844871930a7a09652c7e6">   97</a></span>&#160;    <span class="keyword">def </span><a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a89272bfa78d844871930a7a09652c7e6" title="Parses the TRS file, returning a list of Segments.">parse</a>(self, progress_update_fcn=None, progress_next_phase_fcn=None, validate=True, seg_filters=[], remove_bad_trans_codes=True):</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;        <span class="comment">#make sure the xml was readable, and results have not yet been cached</span></div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;        <span class="keywordflow">if</span> self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a2e31c227510ed8290d0ad971aa3107c9">tree</a> <span class="keywordflow">and</span> <span class="keywordflow">not</span> self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a93736f8c4f06e5bae05b1a4433a2743d">parsed</a>:</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;            <span class="comment">#parse the file, driving the linking state machine as we go</span></div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;            self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#ae30de104fe6967a970b950ac37ba702c" title="This method performs the actual parsing work that produces a list of Segment objects from the XML...">_parse</a>(progress_update_fcn, seg_filters, remove_bad_trans_codes)</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;            self.link_sm.finish()</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;            <span class="comment">#validate the utterances, if requested</span></div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;            <span class="keywordflow">if</span> validate:</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;                <span class="keywordflow">if</span> progress_next_phase_fcn:</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;                    progress_next_phase_fcn()</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;                cur_utter = 0</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;                <span class="keywordflow">for</span> seg <span class="keywordflow">in</span> self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a9a7a1591931fbb8f57d958c9cc0f10b9">segments</a>:</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;                    <span class="keywordflow">for</span> utter <span class="keywordflow">in</span> seg.utters:</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;                        <span class="comment">#log errors to the collector object</span></div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;                        utter.validate(self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a2ac08990a7782ce750a185a004a3f45d">error_collector</a>)</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;                        cur_utter += 1</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;                        <span class="keywordflow">if</span> progress_update_fcn:</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;                            progress_update_fcn(float(cur_utter) / float(self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a1b123c13ba97fd29d0c5ebca469926e7">total_utters</a>))</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;            </div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;            self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a93736f8c4f06e5bae05b1a4433a2743d">parsed</a> = <span class="keyword">True</span></div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;            self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a2e31c227510ed8290d0ad971aa3107c9">tree</a> = <span class="keywordtype">None</span> <span class="comment">#no need to keep this huge object in memory anymore...</span></div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;        <span class="keywordflow">return</span> self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a9a7a1591931fbb8f57d958c9cc0f10b9">segments</a></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;    <span class="comment">## Retreives an Utterance object (residing in one of this trs parser&#39;s segments) by its utterance id attribute.</span></div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    <span class="comment">#  @param self</span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    <span class="comment">#  @param utter_id (int) utterance id to search for</span></div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;    <span class="comment">#  @returns (Utterance) the requested Utterance object, or None if not found</span></div>
<div class="line"><a name="l00128"></a><span class="lineno"><a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a80b04799f32fdfc4599109e68db5580d">  128</a></span>&#160;    <span class="keyword">def </span><a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a80b04799f32fdfc4599109e68db5580d" title="Retreives an Utterance object (residing in one of this trs parser&#39;s segments) by its utterance id att...">get_utter_by_id</a>(self, utter_id):</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;        result = <span class="keywordtype">None</span></div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;        <span class="comment">#build an index (keyed by utterance id) so that these acceses will be faster in the future</span></div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;        <span class="comment">#note: this only involves copying pointers, not actual data...</span></div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a98e49ff8cc4d465a391072925eb0d181">utter_index</a>:</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;            self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a89272bfa78d844871930a7a09652c7e6" title="Parses the TRS file, returning a list of Segments.">parse</a>()</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;            self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a98e49ff8cc4d465a391072925eb0d181">utter_index</a> = {}</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;            <span class="keywordflow">for</span> seg <span class="keywordflow">in</span> self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a9a7a1591931fbb8f57d958c9cc0f10b9">segments</a>:</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;                <span class="keywordflow">for</span> utter <span class="keywordflow">in</span> seg.utters:</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;                    self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a98e49ff8cc4d465a391072925eb0d181">utter_index</a>[utter.id] = utter</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;        <span class="keywordflow">if</span> utter_id <span class="keywordflow">in</span> self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a98e49ff8cc4d465a391072925eb0d181">utter_index</a>:</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;            result = self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a98e49ff8cc4d465a391072925eb0d181">utter_index</a>[utter_id]</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;        <span class="keywordflow">return</span> result</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;    </div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;    <span class="comment">## This method performs the actual parsing work that produces a list of Segment objects from the XML.</span></div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    <span class="comment">#  @param self</span></div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    <span class="comment">#  @param progress_update_fcn (function) see identical parameter description in parse()</span></div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;    <span class="comment">#  @param seg_filters (list) list of SegFilter objects to apply to the segments as they are created. Anything that these filters exclude will not be in the returned list (their changes are made permanent).</span></div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;    <span class="comment">#  @returns (list) list of Segment objects</span></div>
<div class="line"><a name="l00150"></a><span class="lineno"><a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#ae30de104fe6967a970b950ac37ba702c">  150</a></span>&#160;    <span class="keyword">def </span><a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#ae30de104fe6967a970b950ac37ba702c" title="This method performs the actual parsing work that produces a list of Segment objects from the XML...">_parse</a>(self, progress_update_fcn, seg_filters, remove_bad_trans_codes):</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;        <span class="comment">#make sure xml was readable</span></div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;        <span class="keywordflow">if</span> self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a2e31c227510ed8290d0ad971aa3107c9">tree</a>:</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;            <span class="comment">#retrieve a dictionary of speakers from the xml file and store it in self.speakers</span></div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;            self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a1cb22dceb14ee9a405ed6f4599105408" title="Grabs a list of all of the speakers in the TRS file, from the &lt;Speakers&gt; tag (which appears near the ...">_parse_speakers</a>()</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;            <span class="comment">#grab all turns in the current section element</span></div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;            turn_list = list(self.tree.iter(<span class="stringliteral">&#39;Turn&#39;</span>))</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;            total_turns = len(turn_list)</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;            <span class="comment">#iterate through turns, pulling out utterances</span></div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;            <span class="keywordflow">for</span> turn_num <span class="keywordflow">in</span> range(total_turns):</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;                <span class="comment">#build a list of Speaker objects representing all of the speakers in this segment</span></div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;                <span class="keywordflow">if</span> <span class="keywordflow">not</span> <span class="stringliteral">&#39;speaker&#39;</span> <span class="keywordflow">in</span> turn_list[turn_num].attrib: <span class="comment">#some turns have no speakers</span></div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;                    seg_speakers = []</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;                <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;                    seg_speakers = map(<span class="keyword">lambda</span> spkr_id: self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a99ae17223c6ab8029b9b307d151984da">speakers</a>[spkr_id], turn_list[turn_num].attrib[<span class="stringliteral">&#39;speaker&#39;</span>].split(<span class="stringliteral">&#39; &#39;</span>))</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;                <span class="comment">#construct the segment object</span></div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;                seg = <a class="code" href="classdata__structs_1_1segment_1_1_segment.html" title="This class holds a chunk of information from the TRS file.">Segment</a>(turn_num,</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;                              float(turn_list[turn_num].attrib[<span class="stringliteral">&#39;startTime&#39;</span>]),</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;                              float(turn_list[turn_num].attrib[<span class="stringliteral">&#39;endTime&#39;</span>]),</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;                              seg_speakers)</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;                <span class="comment">#parse the utterances out of this turn element and store them in the segment</span></div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;                seg.utters = self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a8c8e8930097389aa7cecf8c734538c6e" title="Creates Utterance objects for a given XML turn element.">_parse_utters</a>(seg, turn_list[turn_num], remove_bad_trans_codes)</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;                <span class="comment">#make sure this isn&#39;t a segment that the user has requested be filtered out</span></div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;                <span class="keywordflow">if</span> ParserTools.include_seg(seg, seg_filters):</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;                    <span class="comment">#append the newly created segment object to the internal list of segments</span></div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;                    self.segments.append(seg)</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;                <span class="comment">#update any progress bars, if present</span></div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;                <span class="keywordflow">if</span> progress_update_fcn:</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;                    progress_update_fcn(float(turn_num + 1) / float(total_turns))</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;    <span class="comment">## Creates Utterance objects for a given XML turn element.</span></div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;    <span class="comment">#  @param self</span></div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;    <span class="comment">#  @param seg (Segment) the parent Segment object</span></div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;    <span class="comment">#  @param turn (Element) an etree.Element object representing the XML node</span></div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;    <span class="comment">#  @returns (list) list of Utterance objects</span></div>
<div class="line"><a name="l00191"></a><span class="lineno"><a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a8c8e8930097389aa7cecf8c734538c6e">  191</a></span>&#160;    <span class="keyword">def </span><a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a8c8e8930097389aa7cecf8c734538c6e" title="Creates Utterance objects for a given XML turn element.">_parse_utters</a>(self, seg, turn, remove_bad_trans_codes):</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;        <span class="comment">#this state machine handles Utterance creation and assigns their start/end times as we go through the sub-elements in the turn node</span></div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;        sm = <a class="code" href="classparsers_1_1state__machines_1_1_parse_utters_state_machine.html" title="This class handles the task of generating Utterance objects from the data within a.">ParseUttersStateMachine</a>(self, seg, remove_bad_trans_codes)</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;        </div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;        <span class="comment">#advance the state machine for each sub-element in the turn node</span></div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;        <span class="keywordflow">for</span> el <span class="keywordflow">in</span> turn.iter():</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;            sm.drive(el)</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;            </div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;        <span class="comment">#perform any final end time assignments</span></div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;        sm.finish(turn)</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;        <span class="comment">#grab a list of Utterances from the state machine and return it</span></div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;        <span class="keywordflow">return</span> sm.get_result()</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;    <span class="comment">## Extracts Utterance attributes (eg. transcriber codes, transcription phrase, etc.) from the text following a &lt;sync&gt; element.</span></div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;    <span class="comment">#  @param self</span></div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;    <span class="comment">#  @param seg (Segment) A Segment object that Utterances created from this text should appear within.</span></div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;    <span class="comment">#  @param el (etree Element) An XML &quot;text element&quot; from the etree library, containing the data immediately following a &lt;sync&gt; tag. This may span multiple lines.</span></div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;    <span class="comment">#  @returns (list) List of Utterance objects with their attributes set. Multiple Utterance objects are created from the text if it spans multiple lines (different speakers) or uses the &#39;.&#39; operator (see the transcriber manual).</span></div>
<div class="line"><a name="l00210"></a><span class="lineno"><a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a26520cf553bb7395d5673b91740feada">  210</a></span>&#160;    <span class="keyword">def </span><a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a26520cf553bb7395d5673b91740feada" title="Extracts Utterance attributes (eg.">_parse_speech_data</a>(self, seg, el, remove_bad_trans_codes):</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;        utter_list = []</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;        text = el.tail.strip()</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;        <span class="keywordflow">if</span> text:</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;            <span class="comment">#split up separate lines</span></div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;            speaker_utters = re.split(<span class="stringliteral">&#39;\s*\n\s*&#39;</span>, text)</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;            <span class="comment">#each line is treated as a separate utterance, since (according to the transcriber manual) new lines are used for different speakers</span></div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;            <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(speaker_utters)):</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;                <span class="comment">#split at the &#39;.&#39; operator, if present. Transcribers use this to &quot;split apart&quot; segments that LENA has mistakenly put together.</span></div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;                have_multi_utters = re.search(<span class="stringliteral">r&#39;\s*\.\s*&#39;</span>, speaker_utters[i]) != <span class="keywordtype">None</span></div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;                multi_utters = re.split(<span class="stringliteral">r&#39;\s*\.\s*&#39;</span>, speaker_utters[i])</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;                <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range(len(multi_utters)):</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;                    utter = <a class="code" href="classdata__structs_1_1utterance_1_1_utterance.html" title="This class represents an Utterance (though this class&#39;s representation may differ slightly from the l...">Utterance</a>()</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;                    utter.seg = seg</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;                    utter.is_dot_split = have_multi_utters</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;                    self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a1b123c13ba97fd29d0c5ebca469926e7">total_utters</a> += 1</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;                    </div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;                    <span class="comment">#First line has the speaker indicated by LENA. Subsequent lines are considered to be other speakers.</span></div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;                    <span class="keywordflow">if</span> i == 0:</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;                        self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a5be6e9bcb70b7c53216d5f5752602a0d" title="Determines the speaker for an Utterance, and sets the Utterance speaker attribute to an appropriate S...">_assign_speaker</a>(el, utter)</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;                    self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#aae70010f5e06604aece07e1dc2110b55" title="Performs the actual assignment of utterance attributes (like transcription phrase, codes, etc.), based upon a line from the TRS file.">_assign_utter_attribs</a>(utter, multi_utters[j], remove_bad_trans_codes)</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;                    utter_list.append(utter)</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;        <span class="comment">#If the &lt;sync&gt; tag was not transcribed, just create an empty Utterance for it</span></div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;        <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;            utter = <a class="code" href="classdata__structs_1_1utterance_1_1_utterance.html" title="This class represents an Utterance (though this class&#39;s representation may differ slightly from the l...">Utterance</a>()</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;            utter.seg = seg</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;            <span class="keywordflow">if</span> seg.speakers:</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;                <span class="comment">#assume first speaker for now...</span></div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;                utter.speaker = seg.speakers[0]</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;            self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a1b123c13ba97fd29d0c5ebca469926e7">total_utters</a> += 1</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;            utter_list.append(utter)</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;        <span class="keywordflow">return</span> utter_list</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;    <span class="comment">## Determines the speaker for an Utterance, and sets the Utterance speaker attribute to an appropriate Speaker object.</span></div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;    <span class="comment">#  @param self</span></div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;    <span class="comment">#  @param el (etree Element object) The XML element (with either a &quot;sync&quot; or a &quot;who&quot; tag) that corresponds to utter</span></div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;    <span class="comment">#  @param utter (Utterance) The Utterance object to assign a speaker to</span></div>
<div class="line"><a name="l00251"></a><span class="lineno"><a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a5be6e9bcb70b7c53216d5f5752602a0d">  251</a></span>&#160;    <span class="keyword">def </span><a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a5be6e9bcb70b7c53216d5f5752602a0d" title="Determines the speaker for an Utterance, and sets the Utterance speaker attribute to an appropriate S...">_assign_speaker</a>(self, el, utter):</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;        <span class="comment">#&quot;sync&quot; tags receive the enclosing segment&#39;s speaker, if any</span></div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;        <span class="keywordflow">if</span> el.tag == <span class="stringliteral">&#39;Sync&#39;</span>:</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;            utter.speaker = utter.seg.speakers[0] <span class="keywordflow">if</span> len(utter.seg.speakers) &gt; 0 <span class="keywordflow">else</span> <span class="keywordtype">None</span></div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;        <span class="comment">#For &quot;who&quot; tags, we need to examine the &#39;nb&#39; attribute. This gives the index (starts at 1) of the speaker in the enclosing segment&#39;s speaker list.</span></div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;        <span class="keywordflow">elif</span> el.tag == <span class="stringliteral">&#39;Who&#39;</span>:</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;            speaker_index = int(el.attrib[<span class="stringliteral">&#39;nb&#39;</span>]) - 1</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;            <span class="comment">#sometimes there&#39;s human error and we do not have enough speakers in the enclosing segment</span></div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;            <span class="keywordflow">if</span> speaker_index &lt; len(utter.seg.speakers):</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;                utter.speaker = utter.seg.speakers[speaker_index]</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;    <span class="comment">## Performs the actual assignment of utterance attributes (like transcription phrase, codes, etc.), based upon a line from the TRS file.</span></div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;    <span class="comment">#  @param self</span></div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;    <span class="comment">#  @param utter (Utterance) the object we are assigning attributes to</span></div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;    <span class="comment">#  @param line (string) the text following a &quot;sync&quot; or &quot;who&quot; element. This contains LENA codes, plus transcriber added data (and more)</span></div>
<div class="line"><a name="l00266"></a><span class="lineno"><a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#aae70010f5e06604aece07e1dc2110b55">  266</a></span>&#160;    <span class="keyword">def </span><a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#aae70010f5e06604aece07e1dc2110b55" title="Performs the actual assignment of utterance attributes (like transcription phrase, codes, etc.), based upon a line from the TRS file.">_assign_utter_attribs</a>(self, utter, line, remove_bad_trans_codes):</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;        <span class="comment">#sometimes there is no data...</span></div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;        <span class="keywordflow">if</span> (line):</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;            <span class="comment">#grab the data using regex capturing groups</span></div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;            match = re.search(TRSParser.TRANS_LINE_REGEX, line)</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;            <span class="comment">#the above match &quot;should&quot; never fail (the regex will match anything), but it may not capture groups if the corresponding text isn&#39;t present. Therefore we assign them carefully.</span></div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;            utter.trans_phrase = <span class="stringliteral">&#39;&#39;</span></div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;            utter.lena_notes = <span class="stringliteral">&#39;&#39;</span></div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;            codes = <span class="stringliteral">&#39;&#39;</span></div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;            <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;                utter.trans_phrase = match.groups()[0] <span class="keywordflow">or</span> <span class="stringliteral">&#39;&#39;</span> <span class="comment">#change None into empty string</span></div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;                utter.is_trans_overlap = re.search(TRSParser.TRANS_OVERLAP_REGEX, utter.trans_phrase) != <span class="keywordtype">None</span></div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;                utter.lena_notes = match.groups()[1] <span class="keywordflow">or</span> <span class="stringliteral">&#39;&#39;</span></div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;                codes = match.groups()[2] <span class="keywordflow">or</span> <span class="stringliteral">&#39;&#39;</span></div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;            <span class="keywordflow">except</span> Exception <span class="keyword">as</span> err:</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;                self.logger.error(<span class="stringliteral">&#39;Found invalid transcription line in TRS file: %s&#39;</span> % line)</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;            <span class="comment">#assign any codes using another regex</span></div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;            <span class="keywordflow">if</span> codes:</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;                codes_list = re.findall(<span class="stringliteral">&#39;[^\|]+&#39;</span>, codes)</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;                <span class="comment">#These have been verified through TRANS_LINE_REGEX.</span></div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;                lena_codes = codes_list[0: len(codes_list) - 4]</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;                <span class="comment">#These have not.</span></div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;                <span class="comment">#We assume last 4 codes are transcriber codes, setting invalid ones to empty</span></div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;                <span class="comment">#string if the remove_bad_trans_codes flag is set.</span></div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;                trans_codes = codes_list[len(codes_list) - 4:]</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;                <span class="keywordflow">if</span> remove_bad_trans_codes:</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;                    <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(trans_codes)):</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;                        code = trans_codes[i]</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;                        pattern = <span class="stringliteral">&#39;^[%s]%s$&#39;</span> % (<span class="stringliteral">&#39;&#39;</span>.join(DBConstants.TRANS_CODES[i].get_all_options_codes()), <span class="stringliteral">&#39;+&#39;</span> <span class="keywordflow">if</span> i == 2 <span class="keywordflow">else</span> <span class="stringliteral">&#39;&#39;</span>) <span class="comment">#code 2 can have multiple chars</span></div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;                        <span class="keywordflow">if</span> <span class="keywordflow">not</span> re.match(pattern, code):</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;                            trans_codes[i] = <span class="stringliteral">&#39;&#39;</span></div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;                utter.lena_codes = lena_codes</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;                utter.trans_codes = trans_codes</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;                <span class="comment">#let the state machine know that we&#39;ve got this data (this method should really be refactored so that this line can be moved to state_machines.py, where it belongs...)</span></div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;                self.link_sm.drive(utter)</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;    <span class="comment">## Grabs a list of all of the speakers in the TRS file, from the &lt;Speakers&gt; tag (which appears near the top). Creates Speaker objects for them and stores them in the self.speakers list.</span></div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;    <span class="comment">#  @param self</span></div>
<div class="line"><a name="l00310"></a><span class="lineno"><a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a1cb22dceb14ee9a405ed6f4599105408">  310</a></span>&#160;    <span class="keyword">def </span><a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a1cb22dceb14ee9a405ed6f4599105408" title="Grabs a list of all of the speakers in the TRS file, from the &lt;Speakers&gt; tag (which appears near the ...">_parse_speakers</a>(self):</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a99ae17223c6ab8029b9b307d151984da">speakers</a>:</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;            <span class="keywordflow">for</span> person <span class="keywordflow">in</span> self.tree.getroot().find(<span class="stringliteral">&#39;Speakers&#39;</span>).findall(<span class="stringliteral">&#39;Speaker&#39;</span>):</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;                speaker_id = person.attrib[<span class="stringliteral">&#39;id&#39;</span>].strip()</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;                speaker_code = person.attrib[<span class="stringliteral">&#39;name&#39;</span>].strip()</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;                self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a99ae17223c6ab8029b9b307d151984da">speakers</a>[speaker_id] = <a class="code" href="classdata__structs_1_1speaker_1_1_speaker.html" title="This class represents a LENA-defined speaker.">Speaker</a>(speaker_id, DBConstants.SPEAKER_CODES.get_option(speaker_code))</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;                <span class="keywordflow">if</span> self.<a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html#a99ae17223c6ab8029b9b307d151984da">speakers</a>[speaker_id].speaker_codeinfo == <span class="keywordtype">None</span>: <span class="comment">#indicates speaker code is not in the DB table</span></div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;                    self.logger.error(<span class="stringliteral">&#39;Unrecognized speaker code: %s&#39;</span> % (speaker_code))</div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_a5a40681709ed751decc24cd7289c9c5.html">parsers</a></li><li class="navelem"><a class="el" href="trs__parser_8py.html">trs_parser.py</a></li>
    <li class="footer">Generated on Fri Jan 9 2015 16:37:10 for Baby Language Lab Scripts by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.3.1 </li>
  </ul>
</div>
</body>
</html>
