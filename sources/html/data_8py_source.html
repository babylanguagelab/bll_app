<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>Baby Language Lab Scripts: C:/Users/Wayne/Documents/baby-lab/bll_app/custom_scripts/dana/data.py Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="bll_icon.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Baby Language Lab Scripts
   </div>
   <div id="projectbrief">Some GUI applications for general lab use.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Packages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('data_8py_source.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">data.py</div>  </div>
</div><!--header-->
<div class="contents">
<a href="data_8py.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno"><a class="code" href="namespacecustom__scripts_1_1dana_1_1data.html">    1</a></span>&#160;<span class="keyword">import</span> logging</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="keyword">import</span> os</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="keyword">import</span> csv</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="keyword">import</span> glob</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="keyword">import</span> numpy</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="keyword">from</span> <a class="code" href="namespacedb_1_1database.html">db.database</a> <span class="keyword">import</span> Database</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="keyword">from</span> <a class="code" href="namespaceparsers_1_1trs__parser.html">parsers.trs_parser</a> <span class="keyword">import</span> TRSParser</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment"># #this file contains rows for all children</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment"># activities_filename = &#39;C:/Experimental Data/Wayne/activities/all_activities.csv&#39;</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment"># #this folder contains one folder for each child</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment"># naptime_folders = (&#39;C:/Experimental Data/Daycare Study/ADEX Output/Maddy/Daycare Centre Data/&#39;,</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment">#                   &#39;C:/Experimental Data/Daycare Study/ADEX Output/Maddy/Home Daycare Data/&#39;,</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment">#                   &#39;C:/Experimental Data/Daycare Study/ADEX Output/Maddy/Home Data/&#39;,</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment">#                   )</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment"># #this folder contains one file for each child</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment"># src_folders = (&#39;C:/Experimental Data/Daycare Study/ADEX Output/Praat Interface - Dana/DaycareCentre/&#39;,</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment">#               &#39;C:/Experimental Data/Daycare Study/ADEX Output/Praat Interface - Dana/DaycareHome/&#39;,</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="comment">#               &#39;C:/Experimental Data/Daycare Study/ADEX Output/Praat Interface - Dana/Home/&#39;,</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="comment">#               )</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="comment"># #each child will create 2 output files. (1 - stats like min, max, mean, Q1, Q3, etc. and 2 - desired combined output data like speaker, start, elapsed time, date, activity, naptime)</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="comment"># dest_folders = (&#39;C:/Experimental Data/Wayne/dest/DaycareCentre/&#39;,</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment">#                &#39;C:/Experimental Data/Wayne/dest/DaycareHome/&#39;,</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="comment">#                &#39;C:/Experimental Data/Wayne/dest/Home/&#39;,</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="comment">#                )</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;</div>
<div class="line"><a name="l00031"></a><span class="lineno"><a class="code" href="namespacecustom__scripts_1_1dana_1_1data.html#ab16cd410b8d31783f4ae7c03d6af344a">   31</a></span>&#160;activities_filename = <span class="stringliteral">&#39;C:/Users/Wayne/Documents/baby-lab/bll_app/custom_scripts/dana/activities/all_activities.csv&#39;</span></div>
<div class="line"><a name="l00032"></a><span class="lineno"><a class="code" href="namespacecustom__scripts_1_1dana_1_1data.html#aec1cb38006a2549d78d2966639fc23b3">   32</a></span>&#160;naptime_folders = (<span class="stringliteral">&#39;C:/Users/Wayne/Documents/baby-lab/bll_app/custom_scripts/dana/naptime/&#39;</span>,)</div>
<div class="line"><a name="l00033"></a><span class="lineno"><a class="code" href="namespacecustom__scripts_1_1dana_1_1data.html#af15e7a06f7e7e51460ec370d812b69e5">   33</a></span>&#160;src_folders = (<span class="stringliteral">&#39;C:/Users/Wayne/Documents/baby-lab/bll_app/custom_scripts/dana/src/&#39;</span>,)</div>
<div class="line"><a name="l00034"></a><span class="lineno"><a class="code" href="namespacecustom__scripts_1_1dana_1_1data.html#a7dcb0a0eb962675b3179b8d1958b5c1c">   34</a></span>&#160;dest_folders = (<span class="stringliteral">&#39;C:/Users/Wayne/Documents/baby-lab/bll_app/custom_scripts/dana/dest/&#39;</span>,)</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;</div>
<div class="line"><a name="l00036"></a><span class="lineno"><a class="code" href="namespacecustom__scripts_1_1dana_1_1data.html#a90c0fb315201b18c06262d5337c68b95">   36</a></span>&#160;dest_cols = <span class="stringliteral">&#39;Start Duration Speaker Activity Date Elapsed_Time Average_SignalLevel Peak_SignalLevel&#39;</span>.<a class="code" href="namespacesplit.html">split</a>()</div>
<div class="line"><a name="l00037"></a><span class="lineno"><a class="code" href="namespacecustom__scripts_1_1dana_1_1data.html#a775e628b14cb0e8144847716929ae016">   37</a></span>&#160;stats_cols = <span class="stringliteral">&#39;Speaker Min Max Q1 Mean(Q2) Q3&#39;</span>.<a class="code" href="namespacesplit.html">split</a>()</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;</div>
<div class="line"><a name="l00039"></a><span class="lineno"><a class="code" href="namespacecustom__scripts_1_1dana_1_1data.html#a95a8b1789942d743b1d35c8de4f9e411">   39</a></span>&#160;speaker_cats = {</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;    <span class="comment">#near</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;    <span class="stringliteral">&#39;CHN&#39;</span>: (<span class="stringliteral">&#39;CHN&#39;</span>,),</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;    <span class="stringliteral">&#39;ADN&#39;</span>: (<span class="stringliteral">&#39;FAN&#39;</span>, <span class="stringliteral">&#39;MAN&#39;</span>,),</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;    <span class="stringliteral">&#39;CXN&#39;</span>: (<span class="stringliteral">&#39;CXN&#39;</span>,),</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;    <span class="stringliteral">&#39;OLN&#39;</span>: (<span class="stringliteral">&#39;OLN&#39;</span>,),</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;    <span class="stringliteral">&#39;NVN&#39;</span>: (<span class="stringliteral">&#39;TVN&#39;</span>, <span class="stringliteral">&#39;NON&#39;</span>,),</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;    </div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;    <span class="comment">#distance n/a</span></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;    <span class="stringliteral">&#39;SIL&#39;</span>: (<span class="stringliteral">&#39;SIL&#39;</span>,),</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;    <span class="stringliteral">&#39;FUZ&#39;</span>: (<span class="stringliteral">&#39;FUZ&#39;</span>,),</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;    </div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;    <span class="comment">#far</span></div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;    <span class="stringliteral">&#39;CHF&#39;</span>: (<span class="stringliteral">&#39;CHF&#39;</span>,),</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;    <span class="stringliteral">&#39;ADF&#39;</span>: (<span class="stringliteral">&#39;FAF&#39;</span>, <span class="stringliteral">&#39;MAF&#39;</span>,),</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;    <span class="stringliteral">&#39;CXF&#39;</span>: (<span class="stringliteral">&#39;CXF&#39;</span>,),</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;    <span class="stringliteral">&#39;OLF&#39;</span>: (<span class="stringliteral">&#39;OLF&#39;</span>,),</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;    <span class="stringliteral">&#39;NVF&#39;</span>: (<span class="stringliteral">&#39;TVF&#39;</span>, <span class="stringliteral">&#39;NOF&#39;</span>,),</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;    }</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;</div>
<div class="line"><a name="l00059"></a><span class="lineno"><a class="code" href="namespacecustom__scripts_1_1dana_1_1data.html#a1b36ae0ead1c1f5602bc9f7753129f26">   59</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespacecustom__scripts_1_1dana_1_1data.html#a1b36ae0ead1c1f5602bc9f7753129f26">create_db</a>():</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    <span class="keywordflow">print</span> <span class="stringliteral">&#39;Creating in-memory database...&#39;</span></div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;    </div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    db = <a class="code" href="classdb_1_1database_1_1_database.html" title="This class provides a basic API layer ontop of an SQLite database.">Database</a>(<span class="stringliteral">&#39;:memory:&#39;</span>)</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;    db.execute_stmt(<span class="stringliteral">&#39;&#39;&#39;</span></div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;<span class="stringliteral">create table activities (</span></div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;<span class="stringliteral">id integer primary key autoincrement,</span></div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;<span class="stringliteral">child_cd text not null,</span></div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;<span class="stringliteral">activity text null,</span></div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;<span class="stringliteral">start real not null,</span></div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;<span class="stringliteral">end real not null</span></div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;<span class="stringliteral">);</span></div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;<span class="stringliteral">&#39;&#39;&#39;</span>)</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    </div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;    db.execute_stmt(<span class="stringliteral">&#39;&#39;&#39;</span></div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;<span class="stringliteral">create index child_index on activities (</span></div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;<span class="stringliteral">child_cd,</span></div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;<span class="stringliteral">start,</span></div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;<span class="stringliteral">end</span></div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;<span class="stringliteral">);</span></div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;<span class="stringliteral">&#39;&#39;&#39;</span>)</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;    <span class="keywordflow">print</span> <span class="stringliteral">&#39;done.\n&#39;</span></div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;    <span class="keywordflow">return</span> db</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;</div>
<div class="line"><a name="l00086"></a><span class="lineno"><a class="code" href="namespacecustom__scripts_1_1dana_1_1data.html#a59b867d72481585ceaab8a782dfc057b">   86</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespacecustom__scripts_1_1dana_1_1data.html#a59b867d72481585ceaab8a782dfc057b">populate_activities</a>(db):</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;    <span class="keywordflow">print</span> <span class="stringliteral">&#39;Populating db using activities file...&#39;</span></div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    </div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;    acts_file = open(activities_filename, <span class="stringliteral">&#39;rb&#39;</span>)</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;    reader = csv.DictReader(acts_file)</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;    rows = list(reader)</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    last_child = <span class="stringliteral">&#39;%s_%d%02d%02d&#39;</span> % (rows[0][<span class="stringliteral">&#39;child_id&#39;</span>].upper(), int(rows[0][<span class="stringliteral">&#39;year&#39;</span>]), int(rows[0][<span class="stringliteral">&#39;month&#39;</span>]), int(rows[0][<span class="stringliteral">&#39;day&#39;</span>]))</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;    accum_time = float(rows[0][<span class="stringliteral">&#39;Elapsed_Time&#39;</span>]) <span class="comment">#elapsed time will restart periodically, so we need to keep a time accumulator var</span></div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;    last_act = rows[0][<span class="stringliteral">&#39;Activity&#39;</span>]</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;    last_act_start = accum_time</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;    last_act_end = <span class="keywordtype">None</span></div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;    last_dur = float(rows[0][<span class="stringliteral">&#39;Interval_Duration&#39;</span>])</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;    </div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;    <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(1, len(rows)):</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;        cur_child = <span class="stringliteral">&#39;%s_%d%02d%02d&#39;</span> % (rows[i][<span class="stringliteral">&#39;child_id&#39;</span>].upper(), int(rows[i][<span class="stringliteral">&#39;year&#39;</span>]), int(rows[i][<span class="stringliteral">&#39;month&#39;</span>]), int(rows[i][<span class="stringliteral">&#39;day&#39;</span>]))</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;        cur_act = rows[i][<span class="stringliteral">&#39;Activity&#39;</span>]</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;        cur_dur = float(rows[i][<span class="stringliteral">&#39;Interval_Duration&#39;</span>])</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;        cur_el_time = float(rows[i][<span class="stringliteral">&#39;Elapsed_Time&#39;</span>])</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;        <span class="keywordflow">if</span> cur_act != last_act <span class="keywordflow">or</span> cur_child != last_child <span class="keywordflow">or</span> i == len(rows) - 1:</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;            last_act_end = accum_time + last_dur</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;            <span class="comment">#insert</span></div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;            db.insert(<span class="stringliteral">&#39;activities&#39;</span>,</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;                  <span class="stringliteral">&#39;child_cd activity start end&#39;</span>.<a class="code" href="namespacesplit.html">split</a>(),</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;                  ((last_child,</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;                    last_act,</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;                    last_act_start,</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;                    last_act_end,</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;                    ),),</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;                  )</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;            <span class="comment">#reset vars for next iteration (set last vars to cur values)</span></div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;            <span class="keywordflow">if</span> cur_child != last_child:</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;                last_act_start = cur_el_time</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;                accum_time = cur_el_time</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;                last_dur = 0</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;            <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;                last_act_start = accum_time + last_dur</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;                accum_time += cur_dur</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;                last_dur = cur_dur</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;                </div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;            last_act = cur_act</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;            last_child = cur_child</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;            </div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;        <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;            accum_time += cur_dur</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;    acts_file.close()</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;    <span class="keywordflow">print</span> <span class="stringliteral">&#39;done.\n&#39;</span></div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;</div>
<div class="line"><a name="l00138"></a><span class="lineno"><a class="code" href="namespacecustom__scripts_1_1dana_1_1data.html#a4037e428e609b300a66a11a6b81fc3a5">  138</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespacecustom__scripts_1_1dana_1_1data.html#a4037e428e609b300a66a11a6b81fc3a5">populate_naptime</a>(db, naptime_folder):</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;    <span class="keywordflow">print</span> <span class="stringliteral">&#39;Populating db using naptime files...&#39;</span></div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;    naptime_filenames = glob.glob(<span class="stringliteral">&#39;%s*COMPLETE.csv&#39;</span> % (naptime_folder))</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;    <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(naptime_filenames)):</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;        nap_file = open(naptime_filenames[i], <span class="stringliteral">&#39;rb&#39;</span>)</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;        <span class="keywordflow">print</span> <span class="stringliteral">&#39;Reading naptime file &quot;%s&quot;&#39;</span> % (naptime_filenames[i])</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;        reader = csv.DictReader(nap_file)</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;        rows = list(reader)</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;        month, day, year = rows[0][<span class="stringliteral">&#39;Clock_Time_TZAdj&#39;</span>].<a class="code" href="namespacesplit.html">split</a>(<span class="stringliteral">&#39; &#39;</span>)[0].<a class="code" href="namespacesplit.html">split</a>(<span class="stringliteral">&#39;/&#39;</span>)</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;        <span class="keywordflow">if</span> len(year) == 2:</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;            year = <span class="stringliteral">&#39;20%s&#39;</span> % (year)</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;        child_id = rows[0][<span class="stringliteral">&#39;File_Name&#39;</span>].<a class="code" href="namespacesplit.html">split</a>(<span class="stringliteral">&#39;_&#39;</span>)[0].upper()</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;        child_cd = <span class="stringliteral">&#39;%s_%d%02d%02d&#39;</span> % (child_id, int(year), int(month), int(day))</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;        <span class="comment">#remove all existing naptime db rows for this child (these came from the activities file), and use the naptime file info instead (more accurate)</span></div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;        db.delete(</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;            <span class="stringliteral">&#39;activities&#39;</span>,</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;            where_cond=<span class="stringliteral">&#39;child_cd = ? and activity = ?&#39;</span>,</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;            params=((child_cd, <span class="stringliteral">&#39;naptime&#39;</span>)),</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;            )</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;        dur_col_title = <span class="stringliteral">&#39;Segment_Duration&#39;</span></div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;        <span class="keywordflow">if</span> <span class="stringliteral">&#39;Segment_Duration&#39;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> rows[0]:</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;            dur_col_title = <span class="stringliteral">&#39;Block_Duration&#39;</span></div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;            <span class="keywordflow">print</span> <span class="stringliteral">&#39;Warning: no &quot;Segment_Duration&quot; col found. Using &quot;Block_Duration&quot; instead.&#39;</span></div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;        </div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;        last_is_naptime = bool(rows[0][<span class="stringliteral">&#39;Naptime&#39;</span>].strip().lower() == <span class="stringliteral">&#39;naptime&#39;</span>) <span class="comment">#naptime col is blank if seg is not naptime</span></div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;        accum_time = float(rows[0][<span class="stringliteral">&#39;Elapsed_Time&#39;</span>]) + float(rows[0][dur_col_title]) <span class="comment">#elapsed time will restart periodically, so we need to keep a time accumulator var</span></div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;        nap_start = accum_time <span class="keywordflow">if</span> last_is_naptime <span class="keywordflow">else</span> <span class="keywordtype">None</span></div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;        nap_end = <span class="keywordtype">None</span></div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;        <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range(1, len(rows)):</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;            cur_is_naptime = bool(rows[j][<span class="stringliteral">&#39;Naptime&#39;</span>].strip().lower() == <span class="stringliteral">&#39;naptime&#39;</span>) <span class="comment">#naptime col is blank if seg is not naptime</span></div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;            cur_dur = float(rows[j][dur_col_title])</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;            <span class="keywordflow">if</span> cur_is_naptime <span class="keywordflow">and</span> <span class="keywordflow">not</span> last_is_naptime:</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;                nap_start = accum_time</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;                <span class="comment">#print &#39;nap_start: %f&#39; % (nap_start)</span></div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;                </div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;            <span class="keywordflow">elif</span> <span class="keywordflow">not</span> cur_is_naptime <span class="keywordflow">and</span> last_is_naptime:</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;                nap_end = accum_time</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;                <span class="comment">#print &#39;nap_end: %f&#39; % (nap_end)</span></div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;                <a class="code" href="namespacecustom__scripts_1_1dana_1_1data.html#ae23eb1b0089ab41b1d50a4a6133cd4ee">resolve_naptime_insert</a>(</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;                    db,</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;                    child_cd,</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;                    nap_start,</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;                    nap_end,</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;                    )</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;            <span class="comment">#last row</span></div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;            <span class="keywordflow">if</span> cur_is_naptime <span class="keywordflow">and</span> j == len(rows) - 1:</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;                nap_end = accum_time + cur_dur</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;                <span class="keywordflow">print</span> <span class="stringliteral">&#39;nap_end: %f&#39;</span> % (nap_end)</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;                <a class="code" href="namespacecustom__scripts_1_1dana_1_1data.html#ae23eb1b0089ab41b1d50a4a6133cd4ee">resolve_naptime_insert</a>(</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;                    db,</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;                    child_cd,</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;                    nap_start,</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;                    nap_end</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;                    )</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;            accum_time += cur_dur</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;            last_is_naptime = cur_is_naptime</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;            </div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;        nap_file.close()</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;        <a class="code" href="namespacecustom__scripts_1_1dana_1_1data.html#aa72be92ed2b051141d58f81b90a7410e">smooth_db</a>(db, child_cd)</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;    </div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;    <span class="keywordflow">print</span> <span class="stringliteral">&#39;done.\n&#39;</span></div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;<span class="comment">#Insert a naptime segment (from a naptime-file) into the db, adjusting overlapping segments accordingly.</span></div>
<div class="line"><a name="l00213"></a><span class="lineno"><a class="code" href="namespacecustom__scripts_1_1dana_1_1data.html#ae23eb1b0089ab41b1d50a4a6133cd4ee">  213</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespacecustom__scripts_1_1dana_1_1data.html#ae23eb1b0089ab41b1d50a4a6133cd4ee">resolve_naptime_insert</a>(db, child_cd, nap_start, nap_end):</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;    intersect_rows = db.select(</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;        <span class="stringliteral">&#39;activities&#39;</span>,</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;        <span class="stringliteral">&#39;id start end&#39;</span>.<a class="code" href="namespacesplit.html">split</a>(),</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;        where_cond=<span class="stringliteral">&#39;child_cd = ? and &#39;</span> +</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;        <span class="stringliteral">&#39;((end &gt;= ? and end &lt;= ?) or &#39;</span> + <span class="comment">#db end pt intersects range, or db start pt and db end pt both intersect range</span></div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;        <span class="stringliteral">&#39;(start &lt;= ? and start &gt;= ?) or &#39;</span> + <span class="comment">#db start pt inersects range, or db start pt and db end pt both intersect range</span></div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;        <span class="stringliteral">&#39;(start &lt; ? and end &gt; ?))&#39;</span>, <span class="comment">#some db middle pts intersects range</span></div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;        params=(child_cd,</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;                nap_start, nap_end,</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;                nap_end, nap_start,</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;                nap_start, nap_end,</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;                ),</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;        order_by=<span class="stringliteral">&#39;id ASC&#39;</span></div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;        )</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    <span class="keywordflow">if</span> len(intersect_rows) == 0:</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;        <span class="comment">#insert</span></div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;        db.insert(</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;            <span class="stringliteral">&#39;activities&#39;</span>,</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;            <span class="stringliteral">&#39;child_cd activity start end&#39;</span>.<a class="code" href="namespacesplit.html">split</a>(),</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;            ((child_cd,</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;              <span class="stringliteral">&#39;naptime&#39;</span>,</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;              nap_start,</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;              nap_end,</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;                    ),),</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;            )</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;    i = 0</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;    <span class="keywordflow">while</span> i &lt; len(intersect_rows):</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;        db_id, db_start, db_end = intersect_rows[i]</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;        <span class="keywordflow">if</span> db_end &gt;= nap_start <span class="keywordflow">and</span> db_end &lt;= nap_end: <span class="comment">#db end pt intersects range, or db start pt and db end pt both intersect range</span></div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;            <span class="keywordflow">if</span> db_start &gt;= nap_start: <span class="comment">#db start pt and db end pt both intersect range</span></div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;                db.delete(</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;                    <span class="stringliteral">&#39;activities&#39;</span>,</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;                    where_cond=<span class="stringliteral">&#39;id = ?&#39;</span>,</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;                    params=(db_id,),</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;                    )</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;            <span class="keywordflow">else</span>: <span class="comment">#only db end pt intersects range (db start pt is before nap_start)</span></div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;                db.update(</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;                    <span class="stringliteral">&#39;activities&#39;</span>,</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;                    (<span class="stringliteral">&#39;end&#39;</span>,),</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;                    where_cond=<span class="stringliteral">&#39;id = ?&#39;</span>,</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;                    params=(nap_start, db_id,),</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;                    )</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;        <span class="keywordflow">elif</span> db_start &lt;= nap_end <span class="keywordflow">and</span> db_start &gt;= nap_start: <span class="comment">#db start pt inersects range, or db start pt and db end pt both intersect range</span></div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;            <span class="keywordflow">if</span> db_end &lt;= nap_end: <span class="comment">#db start pt and db end pt both intersect range</span></div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;                db.delete(</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;                    <span class="stringliteral">&#39;activities&#39;</span>,</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;                    where_cond=<span class="stringliteral">&#39;id = ?&#39;</span>,</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;                    params=(db_id,),</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;                    )</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;            <span class="keywordflow">else</span>: <span class="comment">#only db start pt intersects range (db end point is after nap_end)</span></div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;                db.update(</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;                    <span class="stringliteral">&#39;activities&#39;</span>,</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;                    (<span class="stringliteral">&#39;start&#39;</span>,),</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;                    where_cond=<span class="stringliteral">&#39;id = ?&#39;</span>,</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;                    params=(nap_end, db_id,),</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;                    )</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;        <span class="comment">#make sure we never insert the same segment twice (can happen in we have multiple segs intersecting naptime. i.e. if hand-coded naptime starts before activity naptime)</span></div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;        cur_naptime_rows = db.select(</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;            <span class="stringliteral">&#39;activities&#39;</span>,</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;            (<span class="stringliteral">&#39;count(id)&#39;</span>,),</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;            where_cond=<span class="stringliteral">&quot;child_cd = ? AND activity = &#39;naptime&#39; AND start = ? AND end = ?&quot;</span>,</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;            params=(child_cd, nap_start, nap_end,),</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;            )</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;        <span class="keywordflow">if</span> int(cur_naptime_rows[0][0]) == 0:            </div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;            <span class="comment">#insert</span></div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;            db.insert(</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;                <span class="stringliteral">&#39;activities&#39;</span>,</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;                <span class="stringliteral">&#39;child_cd activity start end&#39;</span>.<a class="code" href="namespacesplit.html">split</a>(),</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;                ((child_cd,</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;                  <span class="stringliteral">&#39;naptime&#39;</span>,</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;                  nap_start,</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;                  nap_end,</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;                        ),),</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;                )</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;        i += 1</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;        </div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;<span class="comment">#Fill in any gaps left over from removing the activity-file-naptime-info (after naptime-file-info has been inserted). This is necessary beceause naptime-file-info may not line up exactly with activity-file-naptime-info. This function performs this operation for one child.</span></div>
<div class="line"><a name="l00298"></a><span class="lineno"><a class="code" href="namespacecustom__scripts_1_1dana_1_1data.html#aa72be92ed2b051141d58f81b90a7410e">  298</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespacecustom__scripts_1_1dana_1_1data.html#aa72be92ed2b051141d58f81b90a7410e">smooth_db</a>(db, child_cd):</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;    rows = db.select(</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;        <span class="stringliteral">&#39;activities&#39;</span>,</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;        <span class="stringliteral">&#39;id start end&#39;</span>.<a class="code" href="namespacesplit.html">split</a>(),</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;        where_cond=<span class="stringliteral">&#39;child_cd = ?&#39;</span>,</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;        params=(child_cd,),</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;        order_by=(<span class="stringliteral">&#39;start ASC&#39;</span>,),</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;        )</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;    <span class="keywordflow">if</span> rows:</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;        last_id, last_start, last_end = rows[0]</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;        <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(1, len(rows)):</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;            row_id, row_start, row_end = rows[i]</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;            <span class="keywordflow">if</span> last_end &lt; row_start:</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;                db.update(</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;                    <span class="stringliteral">&#39;activities&#39;</span>,</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;                    (<span class="stringliteral">&#39;end&#39;</span>,),</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;                    where_cond=<span class="stringliteral">&#39;id = ?&#39;</span>,</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;                    params=(row_start, last_id,),</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;                    )</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;                </div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;            last_start = row_start</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;            last_end = row_end</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;            last_id = row_id</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;</div>
<div class="line"><a name="l00323"></a><span class="lineno"><a class="code" href="namespacecustom__scripts_1_1dana_1_1data.html#a87ce41ab51144618c98bb4669f609a3d">  323</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespacecustom__scripts_1_1dana_1_1data.html#a87ce41ab51144618c98bb4669f609a3d">process_src_file</a>(db, src_file, dest_file, stats_file, trs_filename):</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;    trs_segs = []</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;    trs_seg_index = 0</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;    <span class="keywordflow">if</span> os.path.exists(trs_filename):</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;        trs_segs = <a class="code" href="classparsers_1_1trs__parser_1_1_t_r_s_parser.html" title="This class parses transcribed TRS files, producing output in the form of Segment objects (which conta...">TRSParser</a>(trs_filename).parse(validate=<span class="keyword">False</span>)</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;    src_reader = csv.DictReader(src_file)</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;    dest_writer = csv.writer(dest_file)</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;    stats_writer = csv.writer(stats_file)</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;    <span class="comment">#write &quot;done&quot; file</span></div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;    stats_durs = {} <span class="comment">#dict keyed by cat (speaker), with values that are lists of all the durations from rows with that speaker</span></div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;    <span class="keywordflow">for</span> cat <span class="keywordflow">in</span> speaker_cats:</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;        stats_durs[cat] = []</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;    dest_writer.writerow(dest_cols)</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;    rows = list(src_reader)</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;    accum_start = float(rows[0][<span class="stringliteral">&#39;Elapsed_Time&#39;</span>])</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;    accum_end = <span class="keywordtype">None</span></div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;    <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(rows)):</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;        month, day, year = rows[i][<span class="stringliteral">&#39;Clock_Time_TZAdj&#39;</span>].<a class="code" href="namespacesplit.html">split</a>(<span class="stringliteral">&#39; &#39;</span>)[0].<a class="code" href="namespacesplit.html">split</a>(<span class="stringliteral">&#39;/&#39;</span>)</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;        <span class="keywordflow">if</span> len(year) == 2:</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;            year = <span class="stringliteral">&#39;20%s&#39;</span> % (year)</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;        child_id = rows[i][<span class="stringliteral">&#39;File_Name&#39;</span>].<a class="code" href="namespacesplit.html">split</a>(<span class="stringliteral">&#39;_&#39;</span>)[0].upper()</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;        child_cd = <span class="stringliteral">&#39;%s_%d%02d%02d&#39;</span> % (child_id, int(year), int(month), int(day))</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;        <span class="comment">#signal levels</span></div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;        row_avg_sig_lev = rows[i][<span class="stringliteral">&#39;Average_SignalLevel&#39;</span>]</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;        row_peak_sig_lev = rows[i][<span class="stringliteral">&#39;Peak_SignalLevel&#39;</span>]</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;        </div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;        <span class="comment">#speaker and duration</span></div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;        row_speaker = <span class="stringliteral">&#39;&#39;</span></div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;        row_dur = 0</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;        <span class="keywordflow">for</span> cat <span class="keywordflow">in</span> speaker_cats:</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;            cat_dur = reduce(</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;                <span class="keyword">lambda</span> accum, key: accum + (float(rows[i][key]) <span class="keywordflow">if</span> key <span class="keywordflow">in</span> rows[i] <span class="keywordflow">else</span> 0), <span class="comment">#far speakers are not listed in csv cols - they are combined into FUZ</span></div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;                speaker_cats[cat],</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;                0</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;                )</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;            <span class="keywordflow">if</span> cat_dur &gt; 0:</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;                row_dur = cat_dur</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;                row_speaker = cat</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;        accum_end = accum_start + row_dur</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;        <span class="comment">#FUZ rows in csv files are actually far speakers - the far speakers are given in the trs file</span></div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;        <span class="keywordflow">if</span> trs_segs:</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;            seg = trs_segs[trs_seg_index]</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;            </div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;            r_seg_start = round(seg.start, 2)</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;            r_seg_end = round(seg.end, 2)</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;            r_accum_start = round(accum_start, 2)</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;            r_accum_end = round(accum_end, 2)</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;            <span class="comment"># print &#39;num_speakers: %d, TRS: (%0.2f - %0.2f), CSV: (%0.2f - %0.2f), %s, %s&#39; % (</span></div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;            <span class="comment">#         len(seg.speakers),</span></div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;            <span class="comment">#         r_seg_start,</span></div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;            <span class="comment">#         r_seg_end,</span></div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;            <span class="comment">#         r_accum_start,</span></div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;            <span class="comment">#         r_accum_end,</span></div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;            <span class="comment">#         str(r_seg_start &lt;= r_accum_start),</span></div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;            <span class="comment">#         str(r_seg_end &gt;= r_accum_end),</span></div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;            <span class="comment">#         )</span></div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;            <span class="keywordflow">if</span> row_speaker == <span class="stringliteral">&#39;FUZ&#39;</span>:</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;                <span class="keywordflow">if</span> len(seg.speakers) != 1:</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;                    <span class="keywordflow">print</span> <span class="stringliteral">&#39;Warning - segment with multiple speakers found.&#39;</span></div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;                <span class="keywordflow">if</span> r_seg_start &lt;= r_accum_start <span class="keywordflow">and</span> r_seg_end &gt;= r_accum_end:</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;                    real_speaker = seg.speakers[0].speaker_codeinfo.code</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;                    found = <span class="keyword">False</span></div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;                    cats = speaker_cats.keys()</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;                    j = 0</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;                    <span class="keywordflow">while</span> j <span class="keywordflow">in</span> range(len(cats)) <span class="keywordflow">and</span> <span class="keywordflow">not</span> found:</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;                        cur_cat = cats[j]</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;                        found = real_speaker <span class="keywordflow">in</span> speaker_cats[cur_cat]</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;                        <span class="keywordflow">if</span> found:</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;                            row_speaker = cur_cat</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;                        j += 1</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;                <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;                    <span class="keywordflow">print</span> <span class="stringliteral">&#39;Warning - segments and rows out of alignment.&#39;</span></div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;            <span class="keywordflow">if</span> r_accum_end == r_seg_end:</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;                trs_seg_index += 1</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;        <span class="comment">#date (input is m/d/yy, output will be dd-mon-yy)</span></div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;        <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;            date = datetime.strptime(rows[i][<span class="stringliteral">&#39;Clock_Time_TZAdj&#39;</span>], <span class="stringliteral">&#39;%m/%d/%y %H:%M&#39;</span>)</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;        <span class="keywordflow">except</span> ValueError: <span class="comment">#hack for dealing with seconds and other year format(present in only some files)</span></div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;            date = datetime.strptime(rows[i][<span class="stringliteral">&#39;Clock_Time_TZAdj&#39;</span>], <span class="stringliteral">&#39;%m/%d/%Y %H:%M:%S&#39;</span>)</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;        row_date_str = date.strftime(<span class="stringliteral">&#39;%d-%b-%y&#39;</span>)</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;        </div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;        <span class="comment">#activity</span></div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;        results = db.select(</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;                    <span class="stringliteral">&#39;activities&#39;</span>,</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;                    <span class="stringliteral">&#39;start end activity&#39;</span>.<a class="code" href="namespacesplit.html">split</a>(),</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;                    where_cond=<span class="stringliteral">&#39;child_cd = ? and &#39;</span> +</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;                    <span class="stringliteral">&#39;((end &gt;= ? and end &lt;= ?) or &#39;</span> + <span class="comment">#db end pt intersects range, or db start pt and db end pt both intersect range</span></div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;                    <span class="stringliteral">&#39;(start &lt;= ? and start &gt;= ?) or &#39;</span> + <span class="comment">#db start pt inersects range, or db start pt and db end pt both intersect range</span></div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;                    <span class="stringliteral">&#39;(start &lt; ? and end &gt; ?))&#39;</span>, <span class="comment">#some db middle pts intersects range</span></div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;                    params=(child_cd,</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;                            accum_start, accum_end,</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;                            accum_end, accum_start,</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;                            accum_start, accum_end,</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;                            ),</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;                    order_by=<span class="stringliteral">&#39;id ASC&#39;</span></div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;                    )</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;        <span class="comment">#determine the magnitude of the overlap (in seconds)</span></div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;        largest_mag = -1</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;        row_activity = <span class="stringliteral">&#39;&#39;</span></div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;        <span class="comment">#note: results are ordered by id (order of insertion) ascending, so the looping here will ensure that in the case of two activities that equally overlapping the segment, the last one (i.e. the one from the naptime file, if present) will be used.</span></div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;        <span class="keywordflow">for</span> db_row <span class="keywordflow">in</span> results:</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;            db_start, db_end, db_activity = db_row</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;            mag = 0</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;            <span class="comment">#db end pt intersects range, or db start pt and db end pt both intersect range</span></div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;            <span class="keywordflow">if</span> db_end &gt;= accum_start <span class="keywordflow">and</span> db_end &lt;= accum_end:</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;                mag = db_end - max(accum_start, db_start)</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;            <span class="comment">#db start pt inersects range, or db start pt and db end pt both intersect range</span></div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;            <span class="keywordflow">elif</span> db_start &lt;= accum_end <span class="keywordflow">and</span> db_start &gt;= accum_start:</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;                mag = min(accum_end, db_end) - db_start</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;            <span class="comment">#some db middle pts intersects range (db_row completely covers file_row</span></div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;            <span class="keywordflow">else</span>: <span class="comment">#if db_start &lt; accum_start and db_end &gt; accum_end:</span></div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;                mag = accum_end - accum_start</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;            <span class="comment">#update if mag is equal to largest mag, since we want to prefer later overlapping activities from the naptime file (if present) - see comment above the loop</span></div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;            <span class="keywordflow">if</span> mag &gt;= largest_mag:</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;                largest_mag = mag</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;                row_activity = db_activity</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;        row_el_time = float(rows[i][<span class="stringliteral">&#39;Elapsed_Time&#39;</span>])</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;        <span class="keywordflow">if</span> <span class="stringliteral">&#39;naptime&#39;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> row_activity:</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;            stats_durs[row_speaker].append(row_dur)</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;                </div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;        out_row = (</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;            str(accum_start),</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;            str(row_dur),</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;            str(row_speaker),</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;            str(row_activity),</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;            str(row_date_str),</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;            str(row_el_time),</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;            str(row_avg_sig_lev),</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;            str(row_peak_sig_lev),</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;            )</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;        dest_writer.writerow(out_row)</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;        accum_start += row_dur</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;    <span class="comment">#write stats file</span></div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;    <span class="comment">#stats_title_row = [&#39;Durations (from non-naptime rows):&#39;]</span></div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;    <span class="comment">#for i in range(len(stats_cols) - 1): </span></div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;    <span class="comment">#    stats_title_row.append(&#39;&#39;)</span></div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;        </div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;    <span class="comment">#stats_writer.writerow(stats_title_row)</span></div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;    stats_writer.writerow(stats_cols)</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;    </div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;    stats_rows = <a class="code" href="namespacecustom__scripts_1_1dana_1_1data.html#aab7be7dd33c10494a1ef56fa4e059cc9">calc_file_stats</a>(stats_durs)</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;    <span class="keywordflow">for</span> row <span class="keywordflow">in</span> stats_rows:</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;        stats_writer.writerow(row)</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;</div>
<div class="line"><a name="l00488"></a><span class="lineno"><a class="code" href="namespacecustom__scripts_1_1dana_1_1data.html#aab7be7dd33c10494a1ef56fa4e059cc9">  488</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespacecustom__scripts_1_1dana_1_1data.html#aab7be7dd33c10494a1ef56fa4e059cc9">calc_file_stats</a>(stat_durs):</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;    stats = []</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;    </div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;    speakers = speaker_cats.keys()</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;    speakers.sort()</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;    <span class="keywordflow">for</span> cd <span class="keywordflow">in</span> speakers:</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;        data = stat_durs[cd]</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;        n = len(data)</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;</div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;        <span class="keywordflow">if</span> len(stat_durs[cd]) &gt; 0:</div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;            q1 = numpy.percentile(data, 25)</div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;            q3 = numpy.percentile(data, 75)</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;            <span class="comment">#this will loop through all data every time, but we&#39;re not too concerned about efficiency here,</span></div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;            <span class="comment">#since n will be small...</span></div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;            min_val = min(data)</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;            max_val = max(data)</div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;            mean_val = numpy.average(data)</div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;            stats.append((cd, min_val, max_val, mean_val, q1, q3))</div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;        <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;            stats.append((cd, <span class="stringliteral">&#39;No non-naptime rows found.&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>))</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;        </div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;    <span class="keywordflow">return</span> stats</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;</div>
<div class="line"><a name="l00513"></a><span class="lineno"><a class="code" href="namespacecustom__scripts_1_1dana_1_1data.html#a5847ae7805943d98c44350dd75295260">  513</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespacecustom__scripts_1_1dana_1_1data.html#a5847ae7805943d98c44350dd75295260">check_log_file</a>(path):</div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;    <span class="keywordflow">if</span> <span class="keywordflow">not</span> os.path.exists(path):</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;        logfile = open(path, <span class="stringliteral">&#39;w&#39;</span>)</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;        logfile.close()</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;</div>
<div class="line"><a name="l00518"></a><span class="lineno"><a class="code" href="namespacecustom__scripts_1_1dana_1_1data.html#acab081adbaefa7af774daa88325cd824">  518</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespacecustom__scripts_1_1dana_1_1data.html#acab081adbaefa7af774daa88325cd824">textify_csv_files</a>():</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;    <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(dest_folders)):</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;        csv_filenames = glob.glob(<span class="stringliteral">&#39;%s*.csv&#39;</span> % (dest_folders[i]))</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;        <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range(len(csv_filenames)):</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;            csv_filenames[j] = csv_filenames[j].replace(<span class="stringliteral">&#39;\\&#39;</span>, <span class="stringliteral">&#39;/&#39;</span>)</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;            csv_file = open(csv_filenames[j], <span class="stringliteral">&#39;rb&#39;</span>)</div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;            reader = csv.reader(csv_file)</div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;            </div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;            txt_filename = <span class="stringliteral">&#39;%stxt&#39;</span> % (csv_filenames[j][:-3])</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;            txt_file = open(txt_filename, <span class="stringliteral">&#39;wb&#39;</span>)</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;            writer = csv.writer(txt_file, delimiter=<span class="stringliteral">&#39;\t&#39;</span>)</div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;</div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;            <span class="keywordflow">for</span> line <span class="keywordflow">in</span> reader:</div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;                writer.writerow(line)</div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;            </div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;            txt_file.close()</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;            csv_file.close()</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;</div>
<div class="line"><a name="l00537"></a><span class="lineno"><a class="code" href="namespacecustom__scripts_1_1dana_1_1data.html#ac23a975a622f44d3f850ce86c74328f0">  537</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespacecustom__scripts_1_1dana_1_1data.html#ac23a975a622f44d3f850ce86c74328f0">run</a>():</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;    <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(src_folders)):</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;        <span class="keywordflow">print</span> <span class="stringliteral">&#39;Processing folder &quot;%s/&quot; (%d of %d)...&#39;</span> % (src_folders[i].<a class="code" href="namespacesplit.html">split</a>(<span class="stringliteral">&#39;/&#39;</span>)[-2], i + 1, len(src_folders))</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;        </div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;        db = <a class="code" href="namespacecustom__scripts_1_1dana_1_1data.html#a1b36ae0ead1c1f5602bc9f7753129f26">create_db</a>()</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;        <a class="code" href="namespacecustom__scripts_1_1dana_1_1data.html#a59b867d72481585ceaab8a782dfc057b">populate_activities</a>(db)</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;        <a class="code" href="namespacecustom__scripts_1_1dana_1_1data.html#a4037e428e609b300a66a11a6b81fc3a5">populate_naptime</a>(db, naptime_folders[i])</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;        <span class="keywordflow">print</span> <span class="stringliteral">&#39;Examining input files...&#39;</span></div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;        src_filenames = glob.glob(<span class="stringliteral">&#39;%s*.csv&#39;</span> % (src_folders[i]))</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;        <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range(len(src_filenames)):</div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;            <span class="keywordflow">print</span> <span class="stringliteral">&#39;Processing file &quot;%s&quot; (%d of %d)...&#39;</span> % (os.path.basename(src_filenames[j]), j + 1, len(src_filenames))</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;            </div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;            src_file = open(src_filenames[j], <span class="stringliteral">&#39;rb&#39;</span>)</div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;            trs_filename = <span class="stringliteral">&#39;%strs&#39;</span> % (src_filenames[j][:-3])</div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;            dest_file = open(<span class="stringliteral">&#39;%s%s_done.csv&#39;</span> % (dest_folders[i], os.path.basename(src_filenames[j][:-4])), <span class="stringliteral">&#39;wb&#39;</span>)</div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;            stats_file = open(<span class="stringliteral">&#39;%s%s_stats.csv&#39;</span> % (dest_folders[i], os.path.basename(src_filenames[j][:-4])), <span class="stringliteral">&#39;wb&#39;</span>)</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;            </div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;            <a class="code" href="namespacecustom__scripts_1_1dana_1_1data.html#a87ce41ab51144618c98bb4669f609a3d">process_src_file</a>(db, src_file, dest_file, stats_file, trs_filename)</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;            src_file.close()</div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;            dest_file.close()</div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;            stats_file.close()</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;            <span class="keywordflow">print</span> <span class="stringliteral">&#39;done.\n&#39;</span></div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;</div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;        db.close()</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;        <span class="keywordflow">print</span> <span class="stringliteral">&#39;done folder.\n&#39;</span></div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;    <span class="keywordflow">print</span> <span class="stringliteral">&#39;Textifying csv files in dest folder...&#39;</span></div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;    <a class="code" href="namespacecustom__scripts_1_1dana_1_1data.html#acab081adbaefa7af774daa88325cd824">textify_csv_files</a>()</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;    <span class="keywordflow">print</span> <span class="stringliteral">&#39;done.&#39;</span></div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;        </div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;    <span class="keywordflow">print</span> <span class="stringliteral">&#39;Script complete!&#39;</span></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_ee3683e5aa28cfe60d24b306e7917375.html">custom_scripts</a></li><li class="navelem"><a class="el" href="dir_b32e5f1d7b3dbe70416751d082f29b1b.html">dana</a></li><li class="navelem"><a class="el" href="data_8py.html">data.py</a></li>
    <li class="footer">Generated on Sat Feb 1 2014 00:03:44 for Baby Language Lab Scripts by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.3.1 </li>
  </ul>
</div>
</body>
</html>
